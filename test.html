<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>test</title>
<link rel="shortcut icon" href="favicon.png" type="image/png" id="favicon" />

<style>
:root {
  --bar-max: 40px;
}

body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: url("background.gif") center/cover no-repeat;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
  opacity: 0;
  transition: opacity 0.45s ease;
  color: white;
}
body.fade-in { opacity: 1; }

p {
  font-size: 1.1rem;
  color: rgba(255,255,255,0.85);
  margin-bottom: 30px;
}

.welcome-message {
  font-size: 1.7em;
  font-weight: 600;
  color: white;
  margin: 18px 0;
  text-shadow: 0 0 15px rgba(255,255,255,0.7);
  backdrop-filter: blur(3px);
  padding: 12px 24px;
  border-radius: 14px;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.2);
}

.home-btn svg {
  position: absolute;
  top: 20px;
  right: 20px;
  fill: none;
  stroke: white;
  stroke-width: 2;
  transition: transform 0.3s ease-out;
  border-radius: 50%;
  cursor: pointer;
}
.home-btn:hover svg { transform: translateY(-2px); }

#audioControls {
  position: absolute;
  top: 14px;
  left: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: flex-start;
  z-index: 50;
}

#songSelector {
  display: flex;
  align-items: center;
  gap: 10px;
}

.arrow {
  font-size: 14px;
  color: white;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid transparent;
  width: 20px;
  height: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: transform .15s ease;
}
.arrow:hover { transform: translateY(-3px); }

.thumbButton {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  object-fit: cover;
  cursor: pointer;
  border: 2px solid rgba(255,255,255,0.18);
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}
.thumbButton:active { transform: scale(.96); }
.thumbButton.playing {
  box-shadow: 0 10px 30px rgba(255,255,255,0.12), 0 6px 22px rgba(0,0,0,0.6);
}

.meta {
  display: flex;
  flex-direction: column;
  margin-left: 6px;
  min-width: 180px;
}
.meta .title {
  font-weight: 600;
  font-size: 0.95rem;
  color: rgba(255,255,255,0.95);
}
.meta .artist {
  font-size: 0.82rem;
  color: rgba(255,255,255,0.7);
}

/* waveform */
#waveform {
  display: flex;
  gap: 7px;
  height: var(--bar-max);
  align-items: flex-end;
  width: calc(56px + 12px + 180px);
  padding-left: 6px;
  transform: scaleY(-1);
}

.bar {
  width: 5px;
  background: rgba(255,255,255,0.88);
  border-radius: 10px;
  transition: height 0.22s cubic-bezier(.2,.9,.2,1);
  height: 5px;
}
.bar.paused {
  animation: fallBounce .36s ease-out forwards;
}
@keyframes fallBounce {
  0% { height: var(--current-height, 40px); }
  70% { height: 0; }
  100% { height: 0; }
}

@media (max-width:420px) {
  .meta { display:none; }
  #waveform { width: 140px; }
  .thumbButton { width:48px; height:48px; }
}
</style>
</head>

<body>
<audio id="player" preload="auto"></audio>

<a href="/" class="home-btn" aria-label="Home">
  <svg width="24" height="24" viewBox="0 0 24 24">
    <path d="M13.9897 20.9982H19.0001V12H21.0001L12.0001 3L3.04309 12H5.00006V20.9982H10.0001M13.9897 20.9982L13.9988 14.0013C13.9994 13.4885 13.6139 13.0653 13.1167 13.0069L11.0001 13C10.4478 13 10.0001 13.4477 10.0001 14V20.9982M13.9897 20.9982H10.0001"
      stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</a>

<div id="audioControls">
  <div id="songSelector">
    <button id="prevSong" class="arrow">❮</button>
    <img id="songThumb" class="thumbButton" onclick="togglePlayPause()">
    <button id="nextSong" class="arrow">❯</button>

    <div class="meta">
      <div class="title" id="songTitle">—</div>
      <div class="artist" id="songArtist">—</div>
    </div>
  </div>

  <div id="waveform"></div>
</div>

<div class="welcome-message">*✧･ﾟ:* Tian Hong (天紅) *✧･ﾟ:*</div>

<script>
document.addEventListener('DOMContentLoaded', () => document.body.classList.add('fade-in'));

const songs = [
  { src:"ssVid.net--Jumping-Machine-跳楼机.mp3", img:"tiaolouji.jpg", title:"跳樓機", artist:"LBI利比" },
  { src:"ssVid.net--夜半.mp3", img:"unnamed (21).jpg", title:"夜半", artist:"王泽科"},
  { src:"ssVid.net--生分-男版.mp3", img:"unnamed (11).jpg", title:"生分 (男版)", artist:"en" },
];

const audio = document.getElementById("player");
const thumb = document.getElementById("songThumb");
const titleEl = document.getElementById("songTitle");
const artistEl = document.getElementById("songArtist");

let currentSong = 0;
function loadSong(i, autoplay=false) {
  currentSong = (i + songs.length) % songs.length;
  const s = songs[currentSong];
  audio.src = s.src;
  thumb.src = s.img;
  titleEl.textContent = s.title;
  artistEl.textContent = s.artist;

  if (autoplay) {
    if (!audioCtx) initAudio();
    audio.play().catch(()=>{});
  }
}
loadSong(0,false);

document.getElementById("nextSong").onclick = ()=>loadSong(currentSong+1,false);
document.getElementById("prevSong").onclick = ()=>loadSong(currentSong-1,false);

function togglePlayPause(){
  if(!audioCtx) initAudio();
  audio.paused ? audio.play() : audio.pause();
}

/* ----- waveform bars ----- */
const waveform = document.getElementById("waveform");
const barCount = 15;
const bars = [];
const heights = new Array(barCount).fill(0);
const velocity = new Array(barCount).fill(0);

for(let i=0;i<barCount;i++){
  const div=document.createElement("div");
  div.className="bar";
  waveform.appendChild(div);
  bars.push(div);
}

let audioCtx=null, analyser=null, freq=null;

function initAudio(){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  analyser.smoothingTimeConstant = 0.65;

  const src = audioCtx.createMediaElementSource(audio);
  src.connect(analyser);
  analyser.connect(audioCtx.destination);

  freq = new Uint8Array(analyser.frequencyBinCount);
}

/* FIXED BAR SAMPLING — now all bars move */
function animateBars(){
  requestAnimationFrame(animateBars);
  if(!analyser) return;

  analyser.getByteFrequencyData(freq);

  const slice = Math.floor(freq.length / barCount);

  for(let i=0;i<barCount;i++){
    let sum=0;

    // weighted slice to ensure movement
    for(let j=0;j<slice;j++){
      const idx = i*slice + j;
      sum += freq[idx] * (1 + j*0.015);  // slightly increase higher bin impact
    }
    const avg = sum / slice;

    const maxH = 40;
    const target = (avg/255)*maxH;

    let h = heights[i];
    let v = velocity[i];

    const spring=0.25, friction=0.10;

    v += (target-h)*spring;
    v *= 0.82;
    h += v;

    if(h<0) h=0;
    heights[i]=h;
    velocity[i]=v;

    bars[i].style.height = h+"px";
  }
}

audio.addEventListener("play", ()=>{
  thumb.classList.add("playing");
  bars.forEach(b=>b.classList.remove("paused"));
  if(!audioCtx) initAudio();
  animateBars();
});

audio.addEventListener("pause", ()=>{
  thumb.classList.remove("playing");
  bars.forEach((b,i)=>{
    b.style.setProperty("--current-height", heights[i]+"px");
    b.classList.add("paused");
  });
});
</script>
</body>
</html>
